# Worker-only Docker Compose for Distributed Trigger.dev Setup
# ============================================================
# Deploy this on each worker server to connect to your main webapp.
# Workers execute tasks and connect to the webapp via TRIGGER_API_URL.

services:
  supervisor:
    image: 'ghcr.io/triggerdotdev/supervisor:prod-c859be9-1768837617'
    restart: unless-stopped
    depends_on:
      - docker-proxy
    user: root
    command: |
      sh -c "exec /usr/bin/dumb-init -- pnpm run --filter supervisor start"
    environment:
      # Connect to remote webapp (REQUIRED - set in .env)
      TRIGGER_API_URL: ${TRIGGER_API_URL}
      # OTEL endpoint for sending task run logs to the dashboard enable variable to be set in .env
      OTEL_EXPORTER_OTLP_ENDPOINT: '${OTEL_EXPORTER_OTLP_ENDPOINT:-${TRIGGER_API_URL}/otel}'

      # Worker authentication (REQUIRED - get from webapp after first deploy)
      TRIGGER_WORKER_TOKEN: ${TRIGGER_WORKER_TOKEN}

      # Must match webapp's MANAGED_WORKER_SECRET
      MANAGED_WORKER_SECRET: ${MANAGED_WORKER_SECRET}

      # Workload API settings
      TRIGGER_WORKLOAD_API_DOMAIN: supervisor
      TRIGGER_WORKLOAD_API_PORT_EXTERNAL: 8020

      # Docker settings
      DOCKER_HOST: tcp://docker-proxy:2375
      DOCKER_RUNNER_NETWORKS: ${DOCKER_RUNNER_NETWORKS:-${COOLIFY_RESOURCE_UUID:-trigger-worker-net}}
      DOCKER_AUTOREMOVE_EXITED_CONTAINERS: 1
      # Disable machine preset limits for faster task startup (removes CPU/memory constraints)
      DOCKER_ENFORCE_MACHINE_PRESETS: ${DOCKER_ENFORCE_MACHINE_PRESETS:-false}

      # Registry settings (must match webapp)
      DOCKER_REGISTRY_URL: ${DOCKER_REGISTRY_URL}
      DOCKER_REGISTRY_USERNAME: ${REGISTRY_USERNAME:-trigger}
      DOCKER_REGISTRY_PASSWORD: ${REGISTRY_PASSWORD}

      # Scaling settings - configured for 200 concurrent tasks (10 consumers Ã— 20 runs)
      TRIGGER_DEQUEUE_MAX_CONSUMER_COUNT: ${DEQUEUE_CONSUMER_COUNT:-10}
      TRIGGER_DEQUEUE_MAX_RUN_COUNT: ${DEQUEUE_RUN_COUNT:-20}
      TRIGGER_DEQUEUE_INTERVAL_MS: ${DEQUEUE_INTERVAL_MS:-1500}
      # Dequeue scaling - conservative to prevent webapp overload
      TRIGGER_DEQUEUE_MIN_CONSUMER_COUNT: ${DEQUEUE_MIN_CONSUMER_COUNT:-1}
      TRIGGER_DEQUEUE_IDLE_INTERVAL_MS: ${DEQUEUE_IDLE_INTERVAL_MS:-5000}
      TRIGGER_DEQUEUE_SCALING_STRATEGY: ${DEQUEUE_SCALING_STRATEGY:-smooth}
      TRIGGER_DEQUEUE_SCALING_UP_COOLDOWN_MS: ${DEQUEUE_SCALING_UP_COOLDOWN_MS:-10000}
      TRIGGER_DEQUEUE_SCALING_DOWN_COOLDOWN_MS: ${DEQUEUE_SCALING_DOWN_COOLDOWN_MS:-5000}

      # Runner settings (reduced polling for high concurrency)
      RUNNER_SNAPSHOT_POLL_INTERVAL_SECONDS: ${RUNNER_SNAPSHOT_POLL_INTERVAL_SECONDS:-10}

      # Machine presets enforcement (0 = disabled for faster startup)
      ENFORCE_MACHINE_PRESETS: ${ENFORCE_MACHINE_PRESETS:-0}

      # Debug mode
      DEBUG: ${DEBUG:-0}

      # Logging options
      # Send console.log output and detailed run logs to the Trigger.dev dashboard
      SEND_RUN_DEBUG_LOGS: ${SEND_RUN_DEBUG_LOGS:-true}
      # Pretty format logs in container output (useful for local debugging)
      RUNNER_PRETTY_LOGS: ${RUNNER_PRETTY_LOGS:-true}
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8020/health',(r)=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    # Security hardening
    security_opt:
      - no-new-privileges:true
    # Log rotation
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  docker-proxy:
    image: 'tecnativa/docker-socket-proxy:latest'
    restart: unless-stopped
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock:ro'
    environment:
      LOG_LEVEL: info
      POST: 1
      CONTAINERS: 1
      IMAGES: 1
      INFO: 1
      NETWORKS: 1
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "2375"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 5s
    # Security hardening
    security_opt:
      - no-new-privileges:true
    # Log rotation
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
