# Worker Environment Variables for Distributed Trigger.dev Setup
# ==============================================================
# This file is for WORKER servers (supervisor + docker-proxy only)
# Get these values from your webapp deployment

# ============================================
# REQUIRED: Connection to Webapp
# ============================================

# Webapp URL (the URL where your Trigger.dev webapp is accessible)
TRIGGER_API_URL=https://trigger.yourdomain.com

# Worker token (get from webapp logs after first deploy)
# Run: docker logs <trigger-container> | grep -A15 "Worker Token"
TRIGGER_WORKER_TOKEN=tr_wgt_xxxxxxxxxxxxx

# Must match webapp's SERVICE_PASSWORD_MANAGEDWORKER
MANAGED_WORKER_SECRET=your-managed-worker-secret

# ============================================
# REQUIRED: Registry Settings
# ============================================

# Registry URL (where your Docker registry is accessible)
DOCKER_REGISTRY_URL=https://registry.yourdomain.com

# Registry credentials (get from webapp's Coolify environment variables)
REGISTRY_USERNAME=trigger
# This is the auto-generated password from webapp (SERVICE_PASSWORD_REGISTRY in Coolify)
REGISTRY_PASSWORD=your-webapp-service-password-registry

# ============================================
# REQUIRED: Docker Network
# ============================================

# Network name on THIS worker server (from Coolify dashboard for this server)
# This should be the network created by Coolify for this worker service
DOCKER_RUNNER_NETWORKS=worker-generated-network-name

# ============================================
# OPTIONAL: Performance Tuning
# ============================================

# Number of parallel job dequeue threads (increase for more throughput)
DEQUEUE_CONSUMER_COUNT=10

# Jobs processed per dequeue cycle
DEQUEUE_RUN_COUNT=50

# Poll interval in milliseconds (lower = more responsive, higher CPU)
DEQUEUE_INTERVAL_MS=500

# Enforce machine preset resource limits (recommended: 1)
ENFORCE_MACHINE_PRESETS=1

# Enforce Docker resource limits for machine presets
DOCKER_ENFORCE_MACHINE_PRESETS=false

# Debug mode (set to 1 for troubleshooting)
DEBUG=0

# ============================================
# SCALING GUIDE
# ============================================
# For a server with 64 vCPU / 128GB RAM running small-1x tasks:
# - Each small-1x task uses 0.5 vCPU, 0.5GB RAM
# - Theoretical max: ~128 concurrent tasks
# - Recommended (with 20% headroom): ~100 concurrent tasks
#
# Adjust DEQUEUE_CONSUMER_COUNT and DEQUEUE_RUN_COUNT based on:
# - Higher values = more throughput but higher resource usage
# - Lower values = less resource contention

# ============================================================
# RESOURCE LIMITS (Hetzner Cloud NVMe Servers)
# Uncomment ONE section based on your worker server size
# ============================================================

# --- TIER 1: 4 vCPU, 16GB RAM (NVMe) ---
SUPERVISOR_CPUS=3
SUPERVISOR_MEMORY=14G
SUPERVISOR_CPUS_RESERVED=2
SUPERVISOR_MEMORY_RESERVED=8G
DOCKER_PROXY_CPUS=1
DOCKER_PROXY_MEMORY=1G

# --- TIER 2: 8 vCPU, 32GB RAM (NVMe) ---
# SUPERVISOR_CPUS=6
# SUPERVISOR_MEMORY=28G
# SUPERVISOR_CPUS_RESERVED=4
# SUPERVISOR_MEMORY_RESERVED=16G
# DOCKER_PROXY_CPUS=2
# DOCKER_PROXY_MEMORY=2G

# --- TIER 3: 16 vCPU, 64GB RAM (NVMe) ---
# SUPERVISOR_CPUS=14
# SUPERVISOR_MEMORY=58G
# SUPERVISOR_CPUS_RESERVED=8
# SUPERVISOR_MEMORY_RESERVED=32G
# DOCKER_PROXY_CPUS=2
# DOCKER_PROXY_MEMORY=4G

# --- TIER 4: 32 vCPU, 128GB RAM (NVMe) ---
# SUPERVISOR_CPUS=28
# SUPERVISOR_MEMORY=120G
# SUPERVISOR_CPUS_RESERVED=16
# SUPERVISOR_MEMORY_RESERVED=64G
# DOCKER_PROXY_CPUS=4
# DOCKER_PROXY_MEMORY=6G
