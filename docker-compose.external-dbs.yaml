services:
  trigger:
    image: 'ghcr.io/triggerdotdev/trigger.dev@sha256:b208b821aebeafe1e814618e92009e104bcb66d7b67d9aee580f5b12ce9391ca'
    restart: unless-stopped
    depends_on:
      clickhouse:
        condition: service_healthy
      electric:
        condition: service_healthy
      minio:
        condition: service_healthy
      registry:
        condition: service_healthy
    user: root
    command: "sh -c \"chown -R node:node /home/node/shared && exec ./scripts/entrypoint.sh\"\n"
    environment:
      # Coolify magic variable - exposes trigger on port 3000 with auto-generated URL
      SERVICE_FQDN_TRIGGER_3000: ''
      # Database connection
      DATABASE_CONNECTION_LIMIT: 350
      # Concurrency limits
      DEFAULT_ENV_EXECUTION_CONCURRENCY_LIMIT: 1000
      DEFAULT_ORG_EXECUTION_CONCURRENCY_LIMIT: 3000
      # Run engine
      RUN_ENGINE_WORKER_COUNT: 20
      RUN_ENGINE_TASKS_PER_WORKER: 50
      WORKER_CONCURRENCY: 50
      # Queue sizes
      MAXIMUM_DEV_QUEUE_SIZE: 30000
      MAXIMUM_DEPLOYED_QUEUE_SIZE: 150000
      # Queue polling optimization (fast task acceptance for bulk submission)
      MASTER_QUEUE_CONSUMERS_INTERVAL_MS: 100
      MASTER_QUEUE_CONSUMER_DEQUEUE_COUNT: 50
      PROCESS_WORKER_QUEUE_DEBOUNCE_MS: 50
      REMIX_APP_PORT: 3000
      # Using FQDN instead of SERVICE_URL (FQDN is just the domain, so we add https://)
      APP_ORIGIN: 'https://${SERVICE_FQDN_TRIGGER}'
      LOGIN_ORIGIN: 'https://${SERVICE_FQDN_TRIGGER}'
      API_ORIGIN: 'https://${SERVICE_FQDN_TRIGGER}'
      SESSION_SECRET: '${SERVICE_PASSWORD_SESSION}'
      MAGIC_LINK_SECRET: '${SERVICE_PASSWORD_MAGIC}'
      ENCRYPTION_KEY: '${SERVICE_PASSWORD_ENCRYPTION}'
      MANAGED_WORKER_SECRET: '${SERVICE_PASSWORD_MANAGEDWORKER}'
      # External PostgreSQL connection
      DATABASE_URL: '${DATABASE_URL}'
      DIRECT_URL: '${DIRECT_URL}'
      # External Redis connection
      REDIS_HOST: '${REDIS_HOST}'
      REDIS_PORT: '${REDIS_PORT:-6379}'
      REDIS_PASSWORD: '${REDIS_PASSWORD:-}'
      REDIS_TLS_DISABLED: '${REDIS_TLS_DISABLED:-true}'
      ELECTRIC_ORIGIN: 'http://electric:3000'
      DEV_OTEL_EXPORTER_OTLP_ENDPOINT: 'https://${SERVICE_FQDN_TRIGGER}/otel'
      DEPLOY_REGISTRY_HOST: '${SERVICE_FQDN_REGISTRY}'
      DEPLOY_REGISTRY_NAMESPACE: '${REGISTRY_NAMESPACE:-trigger}'
      DEPLOY_REGISTRY_USERNAME: ${REGISTRY_USERNAME:-trigger}
      DEPLOY_REGISTRY_PASSWORD: '${SERVICE_PASSWORD_REGISTRY}'
      OBJECT_STORE_BASE_URL: 'http://minio:9000'
      OBJECT_STORE_ACCESS_KEY_ID: admin
      OBJECT_STORE_SECRET_ACCESS_KEY: '${SERVICE_PASSWORD_MINIO}'
      GRACEFUL_SHUTDOWN_TIMEOUT: 1000
      NODE_MAX_OLD_SPACE_SIZE: ${NODE_MAX_OLD_SPACE_SIZE:-16384}
      TRIGGER_BOOTSTRAP_ENABLED: 1
      TRIGGER_BOOTSTRAP_WORKER_GROUP_NAME: bootstrap
      TRIGGER_BOOTSTRAP_WORKER_TOKEN_PATH: /home/node/shared/worker_token
      CLICKHOUSE_URL: 'http://${CLICKHOUSE_ADMIN_USER:-default}:${SERVICE_PASSWORD_64_CLICKHOUSE}@clickhouse:8123?secure=false'
      CLICKHOUSE_LOG_LEVEL: info
      INTERNAL_OTEL_TRACE_LOGGING_ENABLED: 0
      RUN_REPLICATION_ENABLED: 1
      RUN_REPLICATION_CLICKHOUSE_URL: 'http://${CLICKHOUSE_ADMIN_USER:-default}:${SERVICE_PASSWORD_64_CLICKHOUSE}@clickhouse:8123'
      RUN_REPLICATION_LOG_LEVEL: info
      APP_LOG_LEVEL: info
      TRIGGER_TELEMETRY_DISABLED: 0
      # Email configuration (optional)
      WHITELISTED_EMAILS: '${WHITELISTED_EMAILS:-}'
      EMAIL_TRANSPORT: '${EMAIL_TRANSPORT:-}'
      FROM_EMAIL: '${FROM_EMAIL:-}'
      RESEND_API_KEY: '${RESEND_API_KEY:-}'
    volumes:
      - 'shared-data:/home/node/shared'
    healthcheck:
      test:
        - CMD
        - node
        - '-e'
        - "require('http').get('http://127.0.0.1:3000/healthcheck',(r)=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  electric:
    image: 'electricsql/electric:1.2.9'
    restart: unless-stopped
    environment:
      # External PostgreSQL connection
      DATABASE_URL: '${DATABASE_URL}'
      ELECTRIC_SECRET: '${SERVICE_PASSWORD_64_ELECTRIC}'
      ELECTRIC_USAGE_REPORTING: 'false'
      ELECTRIC_DB_POOL_SIZE: 150
      # Cache settings to reduce DB pressure during high concurrency
      ELECTRIC_CACHE_MAX_AGE: 10
      ELECTRIC_CACHE_STALE_AGE: 120
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  clickhouse:
    image: 'clickhouse/clickhouse-server:25.8'
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    environment:
      CLICKHOUSE_USER: ${CLICKHOUSE_ADMIN_USER:-default}
      CLICKHOUSE_PASSWORD: '${SERVICE_PASSWORD_64_CLICKHOUSE}'
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - 'clickhouse-data:/var/lib/clickhouse'
      - 'clickhouse-logs:/var/log/clickhouse-server'
    healthcheck:
      test: ['CMD-SHELL', 'wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  registry:
    image: 'registry:2'
    restart: unless-stopped
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache apache2-utils
        mkdir -p /auth
        htpasswd -Bbn "$${REGISTRY_USERNAME}" "$${REGISTRY_PASSWORD}" > /auth/htpasswd
        exec /entrypoint.sh /etc/docker/registry/config.yml
    environment:
      # Coolify magic variable - exposes registry on port 5000 with auto-generated URL
      SERVICE_FQDN_REGISTRY_5000: ''
      REGISTRY_USERNAME: ${REGISTRY_USERNAME:-trigger}
      REGISTRY_PASSWORD: '${SERVICE_PASSWORD_REGISTRY}'
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: 'Registry Realm'
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
      REGISTRY_HTTP_SECRET: '${SERVICE_PASSWORD_REGISTRY}'
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5000/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  minio:
    image: bitnamilegacy/minio:latest
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: '${SERVICE_PASSWORD_MINIO}'
      MINIO_DEFAULT_BUCKETS: packets
      MINIO_BROWSER: 'on'
    volumes:
      - 'minio-data:/bitnami/minio/data'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s

  supervisor:
    image: 'ghcr.io/triggerdotdev/supervisor:prod-c859be9-1768837617'
    restart: unless-stopped
    depends_on:
      - docker-proxy
      - trigger
    user: root
    command: "sh -c \"chown -R node:node /home/node/shared && exec /usr/bin/dumb-init -- pnpm run --filter supervisor start\"\n"
    environment:
      # Dequeue settings - optimized for fast task pickup during bulk submission
      TRIGGER_DEQUEUE_MAX_CONSUMER_COUNT: 10
      TRIGGER_DEQUEUE_MAX_RUN_COUNT: 20
      TRIGGER_DEQUEUE_INTERVAL_MS: 100
      TRIGGER_DEQUEUE_IDLE_INTERVAL_MS: 500
      TRIGGER_DEQUEUE_MIN_CONSUMER_COUNT: 2
      TRIGGER_DEQUEUE_SCALING_STRATEGY: aggressive
      TRIGGER_DEQUEUE_SCALING_UP_COOLDOWN_MS: 2000
      # Disable machine preset limits for faster task startup
      DOCKER_ENFORCE_MACHINE_PRESETS: false
      ENFORCE_MACHINE_PRESETS: 0
      # Runner settings (reduced polling for high concurrency)
      RUNNER_SNAPSHOT_POLL_INTERVAL_SECONDS: 5
      TRIGGER_API_URL: http://trigger:3000
      OTEL_EXPORTER_OTLP_ENDPOINT: http://trigger:3000
      TRIGGER_WORKER_TOKEN: 'file:///home/node/shared/worker_token'
      MANAGED_WORKER_SECRET: ${SERVICE_PASSWORD_MANAGEDWORKER}
      TRIGGER_WORKLOAD_API_DOMAIN: supervisor
      TRIGGER_WORKLOAD_API_PORT_EXTERNAL: 8020
      DOCKER_HOST: tcp://docker-proxy:2375
      DOCKER_RUNNER_NETWORKS: ${DOCKER_RUNNER_NETWORKS:-trigger-net}
      DOCKER_AUTOREMOVE_EXITED_CONTAINERS: 1
      DOCKER_REGISTRY_URL: 'https://${SERVICE_FQDN_REGISTRY}'
      DOCKER_REGISTRY_USERNAME: ${REGISTRY_USERNAME:-trigger}
      DOCKER_REGISTRY_PASSWORD: '${SERVICE_PASSWORD_REGISTRY}'
      DEBUG: 0
    volumes:
      - 'shared-data:/home/node/shared'
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8020/health',(r)=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  docker-proxy:
    image: 'tecnativa/docker-socket-proxy:latest'
    restart: unless-stopped
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock:ro'
    environment:
      LOG_LEVEL: info
      POST: 1
      CONTAINERS: 1
      IMAGES: 1
      INFO: 1
      NETWORKS: 1
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "2375"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 5s

volumes:
  clickhouse-data:
  clickhouse-logs:
  minio-data:
  shared-data:
  registry-data:
